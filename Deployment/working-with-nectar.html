<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Working with Nectar</title>
  <meta name="description" content="Working with Nectar
A Collection of Non-Obvious Things About Nectar

Written by @cloudhary. Target a">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:image" content="/opendoc-ogp-best-practices/site.styling_options.logo_path">

  <link rel="icon" href="/opendoc-ogp-best-practices/assets/images/favicon.ico">
  <link href="https://fonts.googleapis.com/css?family=Fira+Mono&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Noto+Serif:400,700" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com/css?family=Noto+Sans:400,700" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/opendoc-ogp-best-practices/assets/styles/normalize.css">
  <link rel="stylesheet" href="/opendoc-ogp-best-practices/assets/styles/main.css">
  <link rel="alternate" type="application/rss+xml" title="Open Government Products - Best Practices"
    href="/opendoc-ogp-best-practices/feed.xml">
  <!-- Polyfill for corejs functions, promises, array.includes, array.from, etc. -->
  <script src="/opendoc-ogp-best-practices/assets/vendor/babel-polyfill.min.js"></script>
  <!-- Polyfill for dom functions -->
  <script src="/opendoc-ogp-best-practices/assets/vendor/dom4.js" charset="utf-8"></script>
  <!-- Polyfill for fetch API -->
  <script src="/opendoc-ogp-best-practices/assets/vendor/fetch.umd.js"></script>
  <!-- Priority Queue library for promises -->
  <script src="/opendoc-ogp-best-practices/assets/js/pqueue.js"></script>
  <!-- Helper functions that should be preloaded go here -->
  <script src="/opendoc-ogp-best-practices/assets/js/helpers.js"></script></head>

<body>
  <div class="site-header no-print">
    <div class="site-header-left">
      <a href="/opendoc-ogp-best-practices/">
        <h1 class="site-header-text">
          Open Government Products - Best Practices
        </h1>
      </a>
      <span class="site-last-updated">
        LAST UPDATED: 02 JUNE 2020
      <span>
    </div>
    <div class="site-header-right"><a id="contact-us" href="https://open.gov.sg/contact-us/" target="_blank">
        <span>Contact Us</span>
      </a>
      <a href="" class="desktop">
        <img class="agency-logo" src="/opendoc-ogp-best-practices/assets/logo.png">
      </a>
      <a href="/opendoc-ogp-best-practices/" class="mobile">
        <img class="agency-logo" src="/opendoc-ogp-best-practices/assets/logo.png">
      </a>
      <a class="search-btn top-mobile-btn">
        <img src="/opendoc-ogp-best-practices/assets/images/search-icon-dark.svg">
      </a>
    </div>
  </div>

  <nav class="site-nav no-print">
    <div class="nav-header no-print">
      <div class="search-box">
        <div class="search-icon-container search-btn">
          <img class="search-icon mobile" src="/opendoc-ogp-best-practices/assets/images/search-icon-dark.svg"/>
          <img class="search-icon" src="/opendoc-ogp-best-practices/assets/images/search-icon-white.svg"/>
          <img class="close-icon" src="/opendoc-ogp-best-practices/assets/images/close.svg"/>
        </div>
        <span class="search-filter hidden">Deployment</span>
        <div class="search-input-container">
          <p class="search-header">search entire site</p>
          <input id="search-box" placeholder="Search titles or keywords" type="text" />
        </div>
        <label class="clear-button">
          <svg class="clear-icon" viewBox="0 0 18 18" width="18" height="18">
            <path d="M2.42755 1L17.0331 15.60554l-1.41423 1.4142L1 2.38402"></path>
            <path d="M1 15.51932L15.51933 1l1.4142 1.4142L2.2978 17.0331"></path>
          </svg>
        </label>
      </div>
      <div class="search-results">
      </div>
    </div>
    <div class="nav-main no-print">

    


<section class="navigation">

<ul class="table-of-directories hidden">
                    <li>    <a href="/opendoc-ogp-best-practices/Development" id="dir_development" class="tod-container">        <div class="directory-item">Development</div>    </a>    </li>                    <li>    <a href="/opendoc-ogp-best-practices/Deployment" id="dir_deployment" class="tod-container">        <div class="directory-item">Deployment</div>    </a>    </li>
</ul>
<div class="back-to-documents">
    <p>Back to Documents <img class="btn-icon" src="/opendoc-ogp-best-practices/assets/images/chevron-up.svg"></p>
</div>




    
    
    <section id="toc_development" class="contents" hidden>
    
    


            

    
        
            

            

            

            

            



    
        
            
        
            
                
                
    
        
            
                
                
    
        
            
        
            
        
            
                
                
    



<ul class="table-of-contents">  <li class="nav-branch"><a href="/opendoc-ogp-best-practices/Development/node-dev-setup.html" class="nav-link"><span class="directory-item"> Node.js Developer Setup </span></a>    <ul>      <li class="nav-branch"><a href="/opendoc-ogp-best-practices/Development/node-dev-setup.html#linting" class="nav-link"><span class="directory-item"> Linting </span></a></li>      <li class="nav-branch"><a href="/opendoc-ogp-best-practices/Development/node-dev-setup.html#running-things-on-a-dev-machine" class="nav-link"><span class="directory-item"> Running things on a dev machine </span></a></li>    </ul>  </li>  <li class="nav-branch"><a href="/opendoc-ogp-best-practices/Development/linting.html" class="nav-link"><span class="directory-item"> Linting </span></a>    <ul>      <li class="nav-branch"><a href="/opendoc-ogp-best-practices/Development/linting.html#setup" class="nav-link"><span class="directory-item"> Setup </span></a></li>      <li class="nav-branch"><a href="/opendoc-ogp-best-practices/Development/linting.html#javascript" class="nav-link"><span class="directory-item"> JavaScript </span></a></li>    </ul>  </li>  <li class="nav-branch"><a href="/opendoc-ogp-best-practices/Development/using-github.html" class="nav-link"><span class="directory-item"> Using GitHub </span></a>    <ul>      <li class="nav-branch"><a href="/opendoc-ogp-best-practices/Development/using-github.html#branching-strategy" class="nav-link"><span class="directory-item"> Branching strategy </span></a></li>      <li class="nav-branch"><a href="/opendoc-ogp-best-practices/Development/using-github.html#branch-naming" class="nav-link"><span class="directory-item"> Branch naming </span></a></li>      <li class="nav-branch"><a href="/opendoc-ogp-best-practices/Development/using-github.html#writing-commits" class="nav-link"><span class="directory-item"> Writing commits </span></a></li>      <li class="nav-branch"><a href="/opendoc-ogp-best-practices/Development/using-github.html#writing-prs-and-comments" class="nav-link"><span class="directory-item"> Writing PRs and Comments </span></a></li>    </ul>  </li></ul>
    </section>

    
    
    <section id="toc_deployment" class="contents">
    
    


            

    
        
            

            

            

            

            



    
        
            
                
                
    
        
            
        
            
                
                
    



<ul class="table-of-contents">  <li class="nav-branch"><a href="/opendoc-ogp-best-practices/Deployment/aws.html" class="nav-link"><span class="directory-item"> AWS Best Practices </span></a>    <ul>      <li class="nav-branch"><a href="/opendoc-ogp-best-practices/Deployment/aws.html#do-not-use-the-root-account" class="nav-link"><span class="directory-item"> Do not use the root account </span></a></li>      <li class="nav-branch"><a href="/opendoc-ogp-best-practices/Deployment/aws.html#enable-mfa-on-all-iam-account-with-console-access" class="nav-link"><span class="directory-item"> Enable MFA on all IAM account with console access </span></a></li>      <li class="nav-branch"><a href="/opendoc-ogp-best-practices/Deployment/aws.html#only-use-your-personal-credentials-for-local-development" class="nav-link"><span class="directory-item"> Only use your personal credentials for local development </span></a></li>      <li class="nav-branch"><a href="/opendoc-ogp-best-practices/Deployment/aws.html#never-ever-hard-code-aws-credentials" class="nav-link"><span class="directory-item"> Never ever hard-code AWS credentials </span></a></li>      <li class="nav-branch"><a href="/opendoc-ogp-best-practices/Deployment/aws.html#make-use-of-iam-roles" class="nav-link"><span class="directory-item"> Make use of IAM roles </span></a></li>      <li class="nav-branch"><a href="/opendoc-ogp-best-practices/Deployment/aws.html#grant-the-least-privilege-possible" class="nav-link"><span class="directory-item"> Grant the least privilege possible </span></a></li>      <li class="nav-branch"><a href="/opendoc-ogp-best-practices/Deployment/aws.html#there-is-a-managed-service-for-that" class="nav-link"><span class="directory-item"> There is a managed service for that! </span></a></li>      <li class="nav-branch"><a href="/opendoc-ogp-best-practices/Deployment/aws.html#use-the-right-region" class="nav-link"><span class="directory-item"> Use the right region </span></a></li>      <li class="nav-branch"><a href="/opendoc-ogp-best-practices/Deployment/aws.html#if-it-is-too-complicated-then-you-are-probably-doing-it-wrong" class="nav-link"><span class="directory-item"> If it is too complicated, then you are probably doing it wrong. </span></a></li>    </ul>  </li>  <li class="nav-branch"><a href="/opendoc-ogp-best-practices/Deployment/working-with-nectar.html" class="nav-link"><span class="directory-item"> Working with Nectar </span></a>    <ul>      <li class="nav-branch"><a href="/opendoc-ogp-best-practices/Deployment/working-with-nectar.html#a-collection-of-non-obvious-things-about-nectar" class="nav-link"><span class="directory-item"> A Collection of Non-Obvious Things About Nectar </span></a></li>      <li class="nav-branch"><a href="/opendoc-ogp-best-practices/Deployment/working-with-nectar.html#what-is-nectar" class="nav-link"><span class="directory-item"> What is Nectar? </span></a></li>      <li class="nav-branch"><a href="/opendoc-ogp-best-practices/Deployment/working-with-nectar.html#how-do-we-build-products-for-nectar" class="nav-link"><span class="directory-item"> How do we build products for Nectar? </span></a></li>      <li class="nav-branch"><a href="/opendoc-ogp-best-practices/Deployment/working-with-nectar.html#development" class="nav-link"><span class="directory-item"> Development </span></a></li>      <li class="nav-branch"><a href="/opendoc-ogp-best-practices/Deployment/working-with-nectar.html#building" class="nav-link"><span class="directory-item"> Building </span></a></li>      <li class="nav-branch"><a href="/opendoc-ogp-best-practices/Deployment/working-with-nectar.html#deploying" class="nav-link"><span class="directory-item"> Deploying </span></a></li>      <li class="nav-branch"><a href="/opendoc-ogp-best-practices/Deployment/working-with-nectar.html#debugging" class="nav-link"><span class="directory-item"> Debugging </span></a></li>      <li class="nav-branch"><a href="/opendoc-ogp-best-practices/Deployment/working-with-nectar.html#some-things-that-dont-yet-exist" class="nav-link"><span class="directory-item"> Some things that don’t yet exist </span></a></li>    </ul>  </li></ul>
    </section>

</section></div>
  </nav><div id="index-div">
  <header class="doc-header no-print">
    <div class=description-container>
      <h2 id="document-title">
        Deployment
      </h2>
      <div>
        <div id="document-subtitle">
          
        </div>
      </div>
    </div>
  </header>

  <div class="toolbar-container no-print">
    <label for="menu-toggle" class="toolbar-button" id="menu-toggle-btn">
            <input type="checkbox" id="menu-toggle" hidden>
            <img class="btn-icon" src="/opendoc-ogp-best-practices/assets/images/sidebar.svg">
            <img class="btn-icon hover" src="/opendoc-ogp-best-practices/assets/images/sidebar-hover.svg">
            <img class="mobile-btn-icon " src="/opendoc-ogp-best-practices/assets/images/menu.svg">
            <img class="mobile-btn-icon close" src="/opendoc-ogp-best-practices/assets/images/x-mobile.svg">
            <div class="tooltip">Toggle Sidebar</div>
        </label><div class="toolbar-button print-btn">
            <img class="btn-icon" src="/opendoc-ogp-best-practices/assets/images/pdf.svg">
            <img class="btn-icon hover" src="/opendoc-ogp-best-practices/assets/images/pdf-hover.svg">
            <div class="tooltip">Save as PDF</div>
        </div><div class="toolbar-button edit-btn">
            <img class="btn-icon" src="/opendoc-ogp-best-practices/assets/images/github.svg">
            <img class="btn-icon hover" src="/opendoc-ogp-best-practices/assets/images/github-hover.svg">
            <div class="tooltip">View on Github</div>
        </div></div>

<div class="fab no-print" id="fab">
    <div class="overlay" id="fab-overlay"></div>
    <div class="back-to-top hidden" id="back-to-top" href="#">
        <img class="btn-icon" src="/opendoc-ogp-best-practices/assets/images/chevron-up-white.svg">
    </div>
    <div class="trigger" id="fab-trigger">
        <img class="btn-icon" src="/opendoc-ogp-best-practices/assets/images/vertical-dots.svg">
        <img class="btn-icon close" src="/opendoc-ogp-best-practices/assets/images/x-mobile.svg">
    </div>
    <div class="actions"><a class="action feedback-btn" href="https://open.gov.sg/contact-us/" target="_blank">
            <img class="btn-icon" src="/opendoc-ogp-best-practices/assets/images/feedback.svg">
            <div class="tooltip">Feedback</div>
        </a>
        <div class="action share-btn">
            <img class="btn-icon" src="/opendoc-ogp-best-practices/assets/images/share.svg">
            <div class="tooltip">Share</div>
        </div>
        <div class="action print-btn">
                <img class="btn-icon" src="/opendoc-ogp-best-practices/assets/images/pdf.svg">
                <div class="tooltip">Save as PDF</div>
            </div><div class="action edit-btn">
                <img class="btn-icon" src="/opendoc-ogp-best-practices/assets/images/github.svg">
                <div class="tooltip">View on Github</div>
            </div></div>
</div>
  </div>

  <main class="site-main" id="main-content" aria-label="Content"><h1 id="working-with-nectar">Working with Nectar</h1>
<h2 id="a-collection-of-non-obvious-things-about-nectar">A Collection of Non-Obvious Things About Nectar</h2>

<p>Written by @cloudhary. Target audience: SWE unfamiliar with Nectar</p>

<h2 id="what-is-nectar">What is Nectar?</h2>
<p>Nectar is a Platform-as-a-Service product (it’s actually Redhat’s Openshift Enterprise) that will build and run your docker images</p>

<h2 id="how-do-we-build-products-for-nectar">How do we build products for Nectar?</h2>

<p>You need to take into account what you’re able to build with so that you architect systems appropriately. You have only two things on Nectar:</p>
<ul>
  <li>Docker containers (that you specify using a Dockerfile)</li>
  <li>Persistence through either volumes or a managed MySQL DB.</li>
</ul>

<p>Do note that each container unit (CU) of Nectar gives you 1Mbps of bandwidth. It can be a bottleneck for data intensive projects.</p>

<h2 id="development">Development</h2>
<p><strong>‼️Containers are run as random user id that is part of root group‼️</strong><br />
This is an important departure from what your usual workflow might have been. It is not the same as running as root. Make sure you simulate this in your dev and staging environments by doing the following:</p>
<ul>
  <li>Run your Docker containers with the user flag, i.e, docker run –user 12345678:0</li>
  <li>Providing appropriate permissions to necessary directories at build time by doing <code class="language-plaintext highlighter-rouge">RUN chmod -R g+rwx &lt;directory of choice&gt;</code>. 
But be mindful - use the aforementioned command with caution as some important directories will not respect the modification. For example, you cannot modify or change permissions of the /etc/hosts file, or anything in the entire /etc and /var directory</li>
</ul>

<h2 id="building">Building</h2>
<p>This is the only phase in the Nectar build process that has internet access. All dependencies should be imported and installed during this phase.</p>

<p>Building takes time, particularly the scanning and transferring stage. Be patient. If you’re eager to improve the situation, do things that will reduce the size of your image. Use a small base image, use fewer packages, don’t import unnecessary dependencies like nodemon, minimize layers, etc.</p>

<p>Do not make assumptions when building and deploying for Nectar. Where possible, use the “verbose” option (–verbose, -v etc.) to be sure of what is going on</p>

<h2 id="deploying">Deploying</h2>
<p>The easiest step of them all. Just click deploy.</p>

<p>Have at least two replicas running so that the underlying Kubernetes can evict any one of them without any impact to your service availability.</p>

<p>After clicking deploy, even if Nectar shows that the deploy was a success, be sure to check the logs to figure it out by your own.</p>

<p>Avoid using the health check endpoint unless you have time to figure it out and monitoring is critical for your application. It is sometimes either a liveness check or a readiness check, and if you set it up wrongly, your code may either never deploy or it may cause a healthy service to continually restart unnecessarily. They already have a monitoring service that will ping your endpoint every 5 mins and send an email to you if it fails. Just rely on that.</p>

<p>You need to use a forward proxy and request for credentials to communicate with any external services. To connect to your other services or the DB tier, use the environment variables</p>

<h2 id="debugging">Debugging</h2>
<p>The Nectar engineers are friendly and helpful. They are keen to see us succeed and are willing to accomodate most requests that are within their paygrade to solve. Raise a service request so that they are able to allocate resources to attend to you. Make friends with them so that you can ask for clarifications. Join the #nectar-warriors channel so that you can ask other OGP engineers who have struggled with</p>

<p>Once you’ve deployed the application, logs don’t show up immediately. They take about 10 seconds to show up. Patiently wait for them and refresh the logs page.</p>

<p>The terminal is quite useful when debugging. You will have an easier time debugging if you install essential tools need during the build time, especially if you use base images. For example, let’s say you want to check if certain routes in your app are working, you could use curl to call it from the terminal. If you didn’t have it installed in the docker image, you would have to go through the entire build process again before you can continue troubleshooting. That could take about 30 mins. So make sure you install all of the tools you need for debugging. Oh, do remember that since you don’t have root privileges, you are unable to run <code class="language-plaintext highlighter-rouge">ping</code> and <code class="language-plaintext highlighter-rouge">traceroute</code>. Check the linux man page to figure out if you need to be root. Usually, you’re going to want to have <code class="language-plaintext highlighter-rouge">curl</code> installed and you’ll need to make do with just that.</p>

<h2 id="some-things-that-dont-yet-exist">Some things that don’t yet exist</h2>
<p>A couple of things that you might find yourself craving that don’t yet exist: Travis CI, Serverless functions, MongoDB, docker-compose, multi-stage builds, SSH into container from command line, interactive terminal (file editing software like vi don’t work, for example), Auto scaling, Terraform / Infra as Code</p>


  </main>
  <div class="site-branding no-print">
    Powered by <a href="https://opendoc.sg"><img src="/opendoc-ogp-best-practices/assets/images/opendoc-logo-full.svg"></a>
  </div>

  <script src="/opendoc-ogp-best-practices/assets/vendor/jump.min.js" charset="utf-8"></script>
  <script src="/opendoc-ogp-best-practices/assets/vendor/headroom.min.js" charset="utf-8"></script>
  <script src="/opendoc-ogp-best-practices/assets/vendor/mark.min.js" charset="utf-8"></script>
  <script src="/opendoc-ogp-best-practices/assets/vendor/web-share-shim.bundle.min.js"></script>
  <script src="/opendoc-ogp-best-practices/assets/js/toolbar.js"></script>
  <script src="/opendoc-ogp-best-practices/assets/js/page-index.js"></script>
  <script src="/opendoc-ogp-best-practices/assets/js/pre-loader.js"></script>
  <script src="/opendoc-ogp-best-practices/assets/js/lunr.min.js"></script>
  <script src="/opendoc-ogp-best-practices/assets/js/search.js"></script>
  <script src="/opendoc-ogp-best-practices/assets/js/header.js"></script>
  <script src="/opendoc-ogp-best-practices/assets/js/navigation.js"></script>
</body>

</html>
